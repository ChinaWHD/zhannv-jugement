<!DOCTYPE html>
<html>
<head>
  <title>å…ƒå®‡å®™è¡™é—¨ - æƒ…æ„Ÿé¡¾é—®</title>
  <meta charset="UTF-8">
  <style>
    body { 
      font-family: 'SimSun', 'å®‹ä½“', serif; 
      margin: 0; 
      padding: 0; 
      background-color: #f9f6e8;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      position: relative;
    }
    
    header {
      background-color: #8b0000;
      color: #f9f6e8;
      text-align: center;
      padding: 10px 0;
      font-size: 24px;
      font-weight: bold;
      border-bottom: 4px solid #5a0000;
    }
    
    .courtroom {
      width: 100%;
      height: 300px;
      background-image: url('/assets/background.jpg');
      background-size: cover;
      background-position: center;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center; /* å°†é¼“æ”¾åœ¨ä¸­å³ä¾§ */
      justify-content: flex-end;
      padding-bottom: 20px;
    }
    
    .drum {
      width: 300px; /* å¢å¤§é¼“çš„å°ºå¯¸åˆ°300px */
      height: 300px;
      background-image: url('/assets/drum.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 10px;
      position: absolute;
      bottom: 0; /* è°ƒæ•´ä½¿æ”¯æ¶æ¥è§¦åœ°é¢ */
      right: 15%; /* æ›´é è¿‘å³ä¾§ä¸€äº› */
      z-index: 10;
    }
    
    .drum:hover {
      transform: scale(1.05);
    }
    
    .drum:active {
      transform: scale(0.95);
    }
    
    .drum-instruction {
      color: #fff;
      background-color: rgba(0,0,0,0.7);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      position: absolute;
      top: 50%; /* æ”¾åœ¨é¼“é¢ä¸­é—´ */
      left: 50%;
      transform: translate(-50%, -50%); /* å±…ä¸­ */
      pointer-events: none; /* ç¡®ä¿ç‚¹å‡»èƒ½ç©¿é€åˆ°é¼“ */
      z-index: 11;
      white-space: nowrap;
    }
    
    .navigation {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }
    
    .nav-button {
      padding: 10px 20px;
      background-color: #8b0000;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
      font-size: 16px;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 300px; /* å¢åŠ é«˜åº¦ç¡®ä¿å†…å®¹éƒ½èƒ½æ˜¾ç¤º */
      margin: 20px auto;
      transform: translateY(0%); /* ä»-10%è°ƒæ•´ä¸º0%ï¼Œå‘ä¸‹ç§»åŠ¨10% */
      max-width: 936px; /* å·²ç»å¢åŠ 20% */
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
      z-index: 10;
    }
    
    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: #efefef;
    }
    
    .user-message {
      background-color: #d5eaff;
      padding: 10px 15px;
      border-radius: 18px 18px 0 18px;
      margin: 8px 0;
      margin-left: 30px;
      display: inline-block;
      max-width: 70%;
      float: right;
      clear: both;
    }
    
    .bot-message {
      background-color: #fff;
      padding: 10px 15px;
      border-radius: 18px 18px 18px 0;
      margin: 8px 0;
      margin-right: 30px;
      display: inline-block;
      max-width: 70%;
      float: left;
      clear: both;
      border: 1px solid #ddd;
    }
    
    .input-area {
      display: flex;
      justify-content: space-between; /* ç¡®ä¿å…ƒç´ åˆ†å¸ƒå‡åŒ€ */
      align-items: center;
      padding: 10px 20px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      position: relative;
      bottom: 0;
      width: 100%;
      transform: translateY(0%); /* ç§»é™¤transformï¼Œä½¿ç”¨margin-topä»£æ›¿ */
      margin-top: 15px; /* åŠ å¤§é—´è· */
      box-sizing: border-box;
    }
    
    .file-upload {
      margin-right: 10px;
      flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
    }
    
    .chat-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      margin-right: 15px;
      font-size: 14px;
      min-width: 0; /* å…è®¸flexé¡¹æ”¶ç¼©è‡³æ¯”å†…å®¹æ›´å° */
    }
    
    .send-button {
      width: 80px; /* å›ºå®šå®½åº¦ */
      padding: 10px 15px;
      background-color: #8b0000;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
    }
    
    .judgment-panel {
      display: none; /* åˆå§‹éšè— */
      width: 36%; /* å‡å°å®½åº¦ï¼ŒåŸæ¥æ˜¯60%ï¼Œå†å‡å°‘40% */
      max-width: 420px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼ŒåŸæ¥æ˜¯700pxï¼Œå‡å°‘40% */
      margin: 20px auto;
      padding: 15px;
      background-color: #f9f6e8;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }
    
    .judgment-input-container {
      margin-bottom: 15px;
    }
    
    .judgment-input {
      width: 100%;
      min-height: 120px; /* å‡å°‘é«˜åº¦ï¼ŒåŸæ¥æ˜¯150pxï¼Œå‡å°‘20% */
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
      font-size: 16px;
      resize: vertical;
    }
    
    .judgment-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .judgment-name-input {
      width: 40%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }
    
    .scroll-container {
      position: relative;
      margin: 15px 0;
      height: 360px; /* å‡å°é«˜åº¦ï¼ŒåŸæ¥æ˜¯450pxï¼Œå‡å°‘20% */
      background-image: url('/assets/scroll.jpg');
      background-size: 100% 100%;
      background-repeat: no-repeat;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 15px;
    }
    
    .scroll-content {
      width: 40%; /* å·è½´å†…å®¹å®½åº¦ä¸ºå·è½´å®½åº¦çš„40%ï¼Œç¬¦åˆç”¨æˆ·è¦æ±‚ */
      max-height: 80%;
      overflow-y: auto;
      margin: 0 auto;
      padding: 20px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
      position: relative;
      visibility: visible;
    }
    
    .judgment-title {
      font-size: 32px;
      color: #8b0000;
      margin-top: 20%; /* æ ‡é¢˜ä½ç½®å¾€ä¸‹ç§»20% */
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
      padding-top: 20px;
    }
    
    .defendant-name {
      font-size: 24px;
      text-align: left;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .judgment-content {
      font-size: 20px;
      color: #000;
      line-height: 1.8;
      text-align: left;
      text-indent: 2em;
      margin-bottom: 30px;
      flex-grow: 1; /* è®©å†…å®¹åŒºåŸŸè‡ªé€‚åº” */
    }
    
    .judgment-score {
      font-size: 24px;
      text-align: center;
      margin-top: auto;
      margin-bottom: 15%; /* è¯„åˆ†ä½ç½®å¾€ä¸Šç§»30% */
      color: #8b0000;
      font-weight: bold;
    }
    
    .judgment-signature {
      font-size: 20px;
      text-align: right;
      margin-bottom: 15%; /* ç­¾åä½ç½®å¾€ä¸Šç§»15% */
      font-style: italic;
      padding-bottom: 20px;
    }
    
    .loading-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #8b0000;
      font-weight: bold;
      text-align: center;
    }
    
    .judgment-name-input {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
      width: 150px;
    }
    
    .ranking-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 200px;
      height: 100vh;
      background-color: rgba(139, 0, 0, 0.9);
      color: #f9f6e8;
      z-index: 100;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-title {
      text-align: center;
      padding: 10px;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #f9f6e8;
    }
    
    .ranking-scroll-container {
      position: relative;
      flex-grow: 1;
      overflow: hidden;
    }
    
    .ranking-scroll {
      position: absolute;
      width: 100%;
      animation: scrollRanking 30s linear infinite;
    }
    
    @keyframes scrollRanking {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100%); }
    }
    
    /* å½“æ’è¡Œæ¦œé¡¹ç›®hoveræ—¶æš‚åœæ»šåŠ¨ */
    .ranking-scroll:hover {
      animation-play-state: paused;
    }
    
    .ranking-item {
      padding: 10px;
      border-bottom: 1px solid rgba(249, 246, 232, 0.3);
      margin: 0 5px;
    }
    
    .ranking-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 3px;
    }
    
    .ranking-score {
      color: #ffeb3b;
      font-size: 14px;
      margin-bottom: 3px;
    }
    
    .ranking-behavior {
      font-size: 12px;
      color: #ddd;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸä»¥é€‚åº”ä¾§è¾¹æ  */
    .main-content {
      margin-left: 200px;
      width: calc(100% - 200px);
    }
    
    /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
    .file-upload {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }
    
    .file-upload-btn {
      background-color: #f0f0f0;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .file-upload-btn:hover {
      background-color: #e0e0e0;
    }
    
    .file-upload-icon {
      width: 20px;
      height: 20px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>');
      background-repeat: no-repeat;
      background-position: center;
      margin-right: 5px;
    }
    
    .file-input {
      display: none;
    }
    
    /* éšè—è°ƒè¯•æ¶ˆæ¯ */
    .debug-message {
      display: none;
    }
    
    .ranking-panel {
      margin-top: 30px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    
    .ranking-title {
      font-size: 20px;
      color: #8b0000;
      margin-bottom: 15px;
    }
    
    .ranking-list {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    
    .ranking-list th, .ranking-list td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    
    .ranking-list th {
      background-color: #f5f5f5;
    }
    
    .ranking-list tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .ranking-list td.score {
      font-weight: bold;
      color: #8b0000;
    }
    
    .hidden {
      display: none;
    }
    
    .visible {
      display: block;
    }
    
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    
    /* 3Dæ³•åº­åœºæ™¯ç›¸å…³æ ·å¼ */
    #courtroom-3d {
      display: none;
      width: 100%;
      height: 600px;
      position: relative;
    }
    
    #character-selection {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 800px;
      width: 80%;
    }
    
    .nav-button.back-button {
      background-color: #5a0000;
    }
    
    .case-number {
      position: absolute;
      top: 10%;
      right: 10%;
      font-size: 18px;
      color: #8b0000;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    
    /* æ·»åŠ  3Dæ¸£ç”·å®¡åˆ¤åº­ æŒ‰é’®æ ·å¼ */
    .btn-3d-court {
      background-color: #8b0000;
      color: white;
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      font-weight: bold;
    }
    
    .btn-3d-court:hover {
      background-color: #a91010;
    }
    
    .btn-3d-court:active {
      transform: translateY(1px);
    }
    
    .btn-3d-court:before {
      content: "ğŸ›ï¸";
      margin-right: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§æ’è¡Œæ¦œ -->
  <div class="ranking-sidebar">
    <div class="sidebar-title">å¸ƒæ¸£æ’è¡Œæ¦œ</div>
    <div class="ranking-scroll-container">
      <div class="ranking-scroll" id="ranking-scroll">
        <!-- æ’è¡Œæ¦œå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>
  
  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <div class="container">
      <header>å…ƒå®‡å®™è¡™é—¨ - æƒ…æ„Ÿé¡¾é—®</header>
      
      <div class="courtroom">
        <div class="drum" id="drum">
          <div class="drum-instruction">ç‚¹å‡»é¼“å¼€å§‹å…¬å®¡æ¸£ç”·</div>
        </div>
      </div>
      
      <div class="navigation">
        <button id="to-chat" class="nav-button">æƒ…æ„Ÿå’¨è¯¢</button>
        <button id="to-3d-court" class="btn-3d-court">3Dæ¸£ç”·å®¡åˆ¤åº­</button>
        <button id="back-from-3d" class="nav-button back-button" style="display: none;">è¿”å›</button>
      </div>
      
      <!-- 3Dæ³•åº­å®¹å™¨ -->
      <div id="courtroom-3d"></div>
      
      <!-- è§’è‰²é€‰æ‹©é¢æ¿ -->
      <div id="character-selection" style="position: relative; display: none;">
        <!-- ç©ºç™½å®¹å™¨ï¼Œå°†ç”±JSå¡«å…… -->
      </div>
      
      <div class="chat-container" id="chat-container">
        <div id="messages" class="messages clearfix">
          <div class="bot-message">ä½ å¥½ï¼Œæˆ‘æ˜¯å…ƒå®‡å®™è¡™é—¨çš„æƒ…æ„Ÿé¡¾é—®ã€‚æœ‰ä»€ä¹ˆæƒ…æ„Ÿé—®é¢˜éœ€è¦äº¤æµå—ï¼Ÿ</div>
        </div>
        <div class="input-area">
          <div class="file-upload">
            <label for="chat-file" class="file-upload-btn">
              <span class="file-upload-icon"></span>
              ä¸Šä¼ å›¾ç‰‡
            </label>
            <input type="file" id="chat-file" class="file-input" accept="image/*">
          </div>
          <input id="chat-input" class="chat-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„é—®é¢˜..." />
          <button id="send-button" class="send-button">å‘é€</button>
        </div>
      </div>
      
      <div class="judgment-panel" id="judgment-panel">
        <h2>æ¸£ç”·å…¬å®¡å¤§ä¼š</h2>
        <div class="judgment-input-container">
          <textarea id="judgment-input" class="judgment-input" placeholder="è¾“å…¥èŠå¤©è®°å½•æˆ–æƒ…æ„Ÿç»å†..." maxlength="500"></textarea>
        </div>
        <div class="judgment-controls">
          <div class="file-upload">
            <label for="judgment-file" class="file-upload-btn">
              <span class="file-upload-icon"></span>
              ä¸Šä¼ æˆªå›¾
            </label>
            <input type="file" id="judgment-file" class="file-input" accept="image/*" onchange="previewImage(this, 'judgment-image-preview')">
          </div>
          <input type="text" id="name-input" class="judgment-name-input" placeholder="è¾“å…¥å¯¹è±¡å§“å/æ˜µç§°">
          <button id="submit-judgment" class="submit-button">æäº¤å…¬å®¡</button>
        </div>
        <div id="judgment-image-preview" class="image-preview" style="margin-top: 10px;"></div>
        
        <div id="judgment-result" class="hidden">
          <div class="scroll-container">
            <div class="loading-text" id="loading-judgment-text">æ­£åœ¨ç”Ÿæˆæ¸£ç”·åˆ¤å†³ä¹¦...</div>
            <div class="scroll-content">
              <div class="judgment-title">æ¸£ç”·åˆ¤å†³ä¹¦</div>
              <div class="case-number" id="case-number">æ¡ˆä»¶ç¼–å·ï¼š2023-001</div>
              <div class="defendant-name" id="defendant-name"></div>
              <div class="judgment-content" id="judgment-text"></div>
              <div class="judgment-score" id="judgment-score"></div>
              <div class="judgment-signature">è¯„å®¡å¤§ä¼šæ‰¹</div>
            </div>
          </div>
        </div>
        
        <!-- æ¸£ç”·æ’è¡Œæ¦œ -->
        <div class="ranking-panel">
          <h3 class="ranking-title">å¸ƒæ¸£æ’è¡Œæ¦œ</h3>
          <table class="ranking-list" id="ranking-table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>å§“å/æ˜µç§°</th>
                <th>æ¸£åº¦</th>
                <th>ä¸»è¦è¡Œä¸º</th>
              </tr>
            </thead>
            <tbody id="ranking-body">
              <!-- æ’è¡Œæ¦œå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
  <audio id="drum-sound" src="/sounds/drum.mp3" preload="auto"></audio>
  
  <!-- å¼•å…¥3Dæ³•åº­è„šæœ¬ -->
  <script src="/js/courtroom3d.js"></script>
  
  <script>
    // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡ä½œä¸ºå¤‡ä»½
    const drumSoundBackup = new Audio('/sounds/drum.mp3');
    
    // å›¾ç‰‡é¢„è§ˆå‡½æ•°
    function previewImage(input, previewId) {
      const preview = document.getElementById(previewId);
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.maxWidth = '100%';
          img.style.maxHeight = '200px';
          img.style.borderRadius = '5px';
          preview.appendChild(img);
          
          // æ·»åŠ åˆ é™¤æŒ‰é’®
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'åˆ é™¤å›¾ç‰‡';
          removeBtn.className = 'remove-image-btn';
          removeBtn.onclick = function() {
            preview.innerHTML = '';
            input.value = '';
          };
          preview.appendChild(removeBtn);
        }
        
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // è·å–DOMå…ƒç´ å¼•ç”¨
      const messagesContainer = document.getElementById('messages');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');
      const toChatButton = document.getElementById('to-chat');
      const to3DButton = document.getElementById('to-3d-court');
      const chatContainer = document.getElementById('chat-container');
      const judgmentPanel = document.getElementById('judgment-panel');
      const submitJudgment = document.getElementById('submit-judgment');
      const rankingTable = document.getElementById('ranking-table');
      const rankingScroll = document.getElementById('ranking-scroll');
      const characterSelection = document.getElementById('character-selection');
      
      // ç¡®ä¿æ‰€æœ‰éœ€è¦ç»‘å®šäº‹ä»¶çš„å…ƒç´ éƒ½å­˜åœ¨
      console.log('å‘é€æŒ‰é’®:', sendButton ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
      console.log('èŠå¤©è¾“å…¥æ¡†:', chatInput ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
      console.log('æ¶ˆæ¯å®¹å™¨:', messagesContainer ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
      
      // å‘é€èŠå¤©æ¶ˆæ¯å‡½æ•°
      async function sendChatMessage() {
        if(!chatInput || !chatInput.value.trim()) return;
        
        const userText = chatInput.value.trim();
        console.log('å‡†å¤‡å‘é€æ¶ˆæ¯:', userText);
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const userMessage = document.createElement('div');
        userMessage.className = 'user-message';
        userMessage.textContent = userText;
        messagesContainer.appendChild(userMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        chatInput.value = '';
        
        // æ˜¾ç¤ºåŠ è½½ä¸­æ¶ˆæ¯
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'bot-message';
        loadingMessage.textContent = 'æ­£åœ¨æ€è€ƒ...';
        messagesContainer.appendChild(loadingMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        try {
          console.log('å‘é€APIè¯·æ±‚:', userText);
          
          // è°ƒç”¨æœåŠ¡å™¨API
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: userText })
          });
          
          console.log('æ”¶åˆ°APIå“åº”çŠ¶æ€:', response.status);
          
          if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('è§£æçš„APIå“åº”:', data);
          
          // ç§»é™¤åŠ è½½æ¶ˆæ¯
          messagesContainer.removeChild(loadingMessage);
          
          // æ˜¾ç¤ºAIå›å¤
          const botMessage = document.createElement('div');
          botMessage.className = 'bot-message';
          botMessage.textContent = data.response || 'æŠ±æ­‰ï¼Œæ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ã€‚';
          messagesContainer.appendChild(botMessage);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } catch (error) {
          console.error('èŠå¤©è¯·æ±‚å¤±è´¥:', error);
          
          // ç§»é™¤åŠ è½½æ¶ˆæ¯
          messagesContainer.removeChild(loadingMessage);
          
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          const errorMessage = document.createElement('div');
          errorMessage.className = 'bot-message';
          errorMessage.textContent = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚';
          messagesContainer.appendChild(errorMessage);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
      if(sendButton) {
        console.log('æ­£åœ¨ç»‘å®šå‘é€æŒ‰é’®äº‹ä»¶');
        // ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        sendButton.removeEventListener('click', sendChatMessage);
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        sendButton.addEventListener('click', sendChatMessage);
      } else {
        console.error('æ‰¾ä¸åˆ°å‘é€æŒ‰é’®å…ƒç´ !');
      }
      
      // å›è½¦å‘é€
      if(chatInput) {
        console.log('æ­£åœ¨ç»‘å®šå›è½¦é”®äº‹ä»¶');
        // ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        chatInput.removeEventListener('keypress', function() {});
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        chatInput.addEventListener('keypress', function(event) {
          if(event.key === 'Enter' && chatInput.value.trim()) {
            console.log('æ•è·åˆ°å›è½¦é”®ï¼Œå‘é€æ¶ˆæ¯');
            sendChatMessage();
          }
        });
      }
      
      // ç»‘å®š3Dæ¸£ç”·å®¡åˆ¤åº­æŒ‰é’®
      if(to3DButton) {
        console.log('æ­£åœ¨ç»‘å®š3Dæ¸£ç”·å®¡åˆ¤åº­æŒ‰é’®');
        to3DButton.addEventListener('click', function() {
          console.log('ç‚¹å‡»3Dæ¸£ç”·å®¡åˆ¤åº­æŒ‰é’®');
          if(window.courtroom3D) {
            window.courtroom3D.show();
          } else {
            console.error('æ‰¾ä¸åˆ°courtroom3Då¯¹è±¡');
          }
        });
      } else {
        console.error('æ‰¾ä¸åˆ°3Dæ¸£ç”·å®¡åˆ¤åº­æŒ‰é’®');
      }
      
      // ç»‘å®šè¿”å›æŒ‰é’®
      const backFromButton = document.getElementById('back-from-3d');
      if(backFromButton) {
        console.log('æ­£åœ¨ç»‘å®šè¿”å›æŒ‰é’®');
        backFromButton.addEventListener('click', function() {
          console.log('ç‚¹å‡»è¿”å›æŒ‰é’®');
          if(window.courtroom3D) {
            window.courtroom3D.hide();
          }
        });
      }
      
      // ç»‘å®šé¼“çš„ç‚¹å‡»äº‹ä»¶
      const drum = document.getElementById('drum');
      if(drum) {
        console.log('æ­£åœ¨ç»‘å®šé¼“ç‚¹å‡»äº‹ä»¶');
        
        // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„éŸ³é¢‘å¯¹è±¡
        const drumAudio = new Audio();
        
        // é¢„å…ˆåŠ è½½é¼“å£°éŸ³é¢‘æ–‡ä»¶
        fetch('/sounds/drum.mp3')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            console.log('æˆåŠŸè·å–é¼“å£°æ–‡ä»¶');
            return response.blob();
          })
          .then(blob => {
            // åˆ›å»ºblob URL
            const audioURL = URL.createObjectURL(blob);
            drumAudio.src = audioURL;
            drumAudio.load();
            console.log('éŸ³é¢‘æ–‡ä»¶å·²åŠ è½½åˆ°æ–°å¯¹è±¡');
          })
          .catch(error => {
            console.error('åŠ è½½é¼“å£°éŸ³é¢‘å¤±è´¥:', error);
          });
        
        // æ·»åŠ é¼“ç‚¹å‡»äº‹ä»¶
        drum.addEventListener('click', function() {
          console.log('ç‚¹å‡»é¼“');
          
          // ä½¿ç”¨å¤šç§æ–¹æ³•å°è¯•æ’­æ”¾å£°éŸ³
          try {
            // æ–¹æ³•1: ä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘å¯¹è±¡
            if (drumAudio.readyState >= 2) {
              console.log('ä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘å¯¹è±¡æ’­æ”¾');
              drumAudio.currentTime = 0;
              drumAudio.volume = 1.0;
              drumAudio.play()
                .then(() => console.log('é¼“å£°æ’­æ”¾æˆåŠŸ'))
                .catch(e => console.error('é¢„åŠ è½½éŸ³é¢‘æ’­æ”¾å¤±è´¥', e));
            } 
            // æ–¹æ³•2: åˆ›å»ºå…¨æ–°éŸ³é¢‘å¯¹è±¡å¹¶æ’­æ”¾
            else {
              console.log('åˆ›å»ºæ–°éŸ³é¢‘å¯¹è±¡æ’­æ”¾');
              const newAudio = new Audio('/sounds/drum.mp3');
              newAudio.volume = 1.0;
              newAudio.play()
                .then(() => console.log('æ–°éŸ³é¢‘å¯¹è±¡æ’­æ”¾æˆåŠŸ'))
                .catch(e => console.error('æ–°éŸ³é¢‘å¯¹è±¡æ’­æ”¾å¤±è´¥', e));
            }
            
            // æ–¹æ³•3: å°è¯•ä½¿ç”¨åŸå§‹audioå…ƒç´ 
            const drumSound = document.getElementById('drum-sound');
            if (drumSound) {
              console.log('å°è¯•ä½¿ç”¨åŸå§‹audioå…ƒç´ ');
              drumSound.currentTime = 0;
              drumSound.volume = 1.0;
              drumSound.play()
                .then(() => console.log('åŸå§‹audioå…ƒç´ æ’­æ”¾æˆåŠŸ'))
                .catch(e => console.error('åŸå§‹audioå…ƒç´ æ’­æ”¾å¤±è´¥', e));
            }
          } catch (error) {
            console.error('æ‰€æœ‰æ’­æ”¾æ–¹æ³•éƒ½å¤±è´¥:', error);
            alert('æ’­æ”¾é¼“å£°å¤±è´¥ï¼Œä½†ä¼šç»§ç»­å¤„ç†');
          }
          
          // å³ä½¿å£°éŸ³æ— æ³•æ’­æ”¾ï¼Œä¹Ÿç»§ç»­åç»­æ“ä½œ
          console.log('åˆ‡æ¢åˆ°åˆ¤å†³é¢æ¿');
          document.getElementById('judgment-panel').style.display = 'block';
          document.getElementById('chat-container').style.display = 'none';
        });
      } else {
        console.error('æ‰¾ä¸åˆ°é¼“å…ƒç´ ');
      }
      
      // åˆå§‹åŒ–3Dæ³•åº­åœºæ™¯
      if(window.courtroom3D) {
        console.log('åˆå§‹åŒ–3Dæ³•åº­åœºæ™¯');
        window.courtroom3D.init();
      } else {
        console.error('æ‰¾ä¸åˆ°courtroom3Då¯¹è±¡');
      }
    });
  </script>
</body>
</html>